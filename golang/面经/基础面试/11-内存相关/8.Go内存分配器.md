## 8.Go内存分配器

[go内存分配器](https://zhuanlan.zhihu.com/p/410317967)

Go 语言的内存分配机制相当复杂且高效，它采用了多种策略和技术来处理不同大小的对象，并尽可能地减少垃圾收集的频率和开销。下面是 Go 语言内存分配的主要组成部分和流程：

### 内存分配层次

1. **栈内存 (Stack)**
   - 栈内存用于存放函数调用的局部变量和函数参数。
   - 栈内存的分配和回收是自动的，随着函数的调用和返回进行。
   - 栈内存的使用非常快，因为它是基于寄存器和CPU指令集的操作。

2. **堆内存 (Heap)**
   - 堆内存用于存放动态分配的对象，包括全局变量、长生命周期的对象和大对象。
   - 堆内存的分配和回收由 Go 运行时的垃圾回收器管理。
   - 堆内存被进一步划分为不同的大小类别，以便更高效地分配和回收不同大小的对象。

### 堆内存管理组件

- **mheap**: 管理整个堆空间，是所有动态内存分配的基础。
- **mcentral**: 每个大小类别都有一个 mcentral 实例，它管理着可用的 mspan。
- **mcache**: 线程本地缓存，每个 goroutine 有一个 mcache，用于快速分配和回收小对象，减少锁的竞争。

### 内存分配单元

- **mspan**: 是 Go 内存管理的基本单元，每个 mspan 包含一组连续的内存页，用于分配相同大小的对象。
- **页**: 操作系统分配给 Go 运行时的最小内存单位，通常是 4KB 或 8KB。

### 分配策略

- **Tiny 分配器**: 用于极小对象（通常小于 32 字节），可以将多个对象分配在同一内存块中，以减少内存碎片。
- **Thread-Local Allocation Buffer (TLAB)**: 每个 goroutine 都有自己的 TLAB，用于快速分配小对象，减少锁的竞争。
- **空闲链表**: 维护已释放的内存块，以便重复使用。

### 对象大小分类

- **小对象**：小于等于 32KB 的对象，会被分配在适当的 mspan 上。
- **大对象**：大于 32KB 的对象，直接从 mheap 分配。

### 内存分配流程

1. 编译器和逃逸分析器决定变量是否需要在堆上分配。
2. 根据对象的大小，选择合适的分配策略。
3. 小对象尝试从当前 goroutine 的 mcache 或 TLAB 分配。
4. 如果 mcache 或 TLAB 中没有足够的空间，则从 mcentral 请求一个新的 mspan。
5. 大对象直接从 mheap 分配。
6. 如果请求的内存大小超过剩余的 mspan 空间，运行时会尝试从操作系统获取更多的内存页。

### 总结

Go 的内存分配机制旨在平衡速度和内存效率，通过线程本地缓存和大小分类来减少锁的竞争和内存碎片，同时利用垃圾回收器自动管理堆上的内存，使得开发人员无需手动管理内存，专注于业务逻辑的编写。



